import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(PriceComparisonApp());
}

class PriceComparisonApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Price Comparison', // Changed title
      theme: ThemeData(primarySwatch: Colors.blue),
      home: HomePage(),
      debugShowCheckedModeBanner: false,
    );
  }
}

class HomePage extends StatefulWidget {
  @override
  _HomePageState createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  final TextEditingController _searchController = TextEditingController();
  final TextEditingController _pincodeController = TextEditingController();
  String userPincode = "";

  @override
  void dispose() {
    _searchController.dispose();
    _pincodeController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Compare Prices')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: <Widget>[
            TextField(
              controller: _searchController,
              decoration: const InputDecoration(
                hintText: 'Search for a product (e.g., Tea Cup)',
                border: OutlineInputBorder(),
                suffixIcon: Icon(Icons.search),
              ),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: _pincodeController,
              keyboardType: TextInputType.number,
              decoration: InputDecoration(
                hintText: 'Enter your pincode',
                border: const OutlineInputBorder(),
                suffixIcon: IconButton(
                  icon: const Icon(Icons.check),
                  onPressed: () {
                    setState(() {
                      userPincode = _pincodeController.text;
                    });
                  },
                ),
              ),
            ),
            const SizedBox(height: 20),
            const Text(
              'Sample Product Result:',
              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
            ),
            const SizedBox(height: 10),
            Expanded(
              child: ListView(
                children: <Widget>[
                  ProductComparisonCard(
                    imageUrl: 'https://www.gstatic.com/flutter-onestack-prototype/genui/example_1.jpg',
                    title: 'Modern Ceramic Tea Cup',
                    sellers: <SellerInfo>[
                      SellerInfo(name: 'Amazon', price: '₹249', delivery: '2-3 Days', rating: '4.3', coupon: 'AMZ10', min: '₹199', max: '₹299', predict: '₹269', affiliateUrl: 'https://amzn.to/example1'),
                      SellerInfo(name: 'Flipkart', price: '₹259', delivery: '3-5 Days', rating: '4.2', coupon: 'FKT15', min: '₹209', max: '₹289', predict: '₹279', affiliateUrl: 'https://fkrt.it/example2'),
                      SellerInfo(name: 'Meesho', price: '₹235', delivery: '5-7 Days', rating: '4.0', coupon: '', min: '₹199', max: '₹279', predict: '₹250', affiliateUrl: 'https://meesho.link/example3'),
                    ],
                    userPincode: userPincode,
                  ),
                ],
              ),
            )
          ],
        ),
      ),
    );
  }
}

class ProductComparisonCard extends StatelessWidget {
  final String imageUrl;
  final String title;
  final List<SellerInfo> sellers;
  final String userPincode;

  const ProductComparisonCard({
    super.key,
    required this.imageUrl,
    required this.title,
    required this.sellers,
    required this.userPincode,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 3,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Padding(
        padding: const EdgeInsets.all(12.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: <Widget>[
            Row(
              children: <Widget>[
                Image.network(imageUrl, width: 80, height: 80),
                const SizedBox(width: 10),
                Expanded(
                  child: Text(title, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
            const SizedBox(height: 10),
            const Text('Compare from Sellers:', style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold)),
            ...sellers.map<Widget>((SellerInfo seller) => SellerRow(seller: seller, pincode: userPincode)).toList(),
          ],
        ),
      ),
    );
  }
}

class SellerInfo {
  final String name;
  final String price;
  final String delivery;
  final String rating;
  final String coupon;
  final String min;
  final String max;
  final String predict;
  final String affiliateUrl;

  SellerInfo({
    required this.name,
    required this.price,
    required this.delivery,
    required this.rating,
    required this.coupon,
    required this.min,
    required this.max,
    required this.predict,
    required this.affiliateUrl,
  });
}

class SellerRow extends StatelessWidget {
  final SellerInfo seller;
  final String pincode;

  const SellerRow({super.key, required this.seller, required this.pincode});

  Future<void> _launchUrl(Uri url) async {
    if (!await launchUrl(url, mode: LaunchMode.externalApplication)) {
      throw 'Could not launch $url';
    }
  }

  @override
  Widget build(BuildContext context) {
    return Card(
      color: Colors.grey.shade100,
      margin: const EdgeInsets.symmetric(vertical: 6),
      child: ListTile(
        title: Text(seller.name, style: const TextStyle(fontWeight: FontWeight.bold)),
        subtitle: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: <Widget>[
            Text('Price: ${seller.price} | Delivery: ${seller.delivery} | Rating: ${seller.rating}'),
            Text('Price Stats - Min: ${seller.min}, Max: ${seller.max}, Predict: ${seller.predict}'),
            if (seller.coupon.isNotEmpty) Text('Coupon: ${seller.coupon}', style: const TextStyle(color: Colors.green)),
            if (pincode.isNotEmpty) Text('Est. Delivery for $pincode: ${seller.delivery}', style: const TextStyle(color: Colors.blue)),
          ],
        ),
        trailing: ElevatedButton(
          onPressed: () {
            _launchUrl(Uri.parse(seller.affiliateUrl));
          },
          child: const Text('Buy Now'),
        ),
      ),
    );
  }
}
